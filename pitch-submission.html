<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Pitch - PitchFrame</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        .pitch-form-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .file-upload-area:hover {
            border-color: #0d6efd;
            background-color: rgba(13, 110, 253, 0.05);
        }
    </style>
</head>
<body class="bg-light">
    <div class="container">
        <div class="pitch-form-container">
            <h2 class="text-center mb-4">Submit Your Pitch</h2>
            <form id="pitchSubmissionForm">
                <div class="mb-3">
                    <label for="pitchTitle" class="form-label">Pitch Title</label>
                    <input type="text" class="form-control" id="pitchTitle" required>
                </div>
                <div class="mb-3">
                    <label for="pitchDescription" class="form-label">Brief Description</label>
                    <textarea class="form-control" id="pitchDescription" rows="3" required></textarea>
                </div>
                <div class="mb-4">
                    <div class="file-upload-area" id="dropZone">
                        <i class="fas fa-cloud-upload-alt fs-1 text-primary mb-3"></i>
                        <p class="mb-2">Drag and drop your pitch deck here</p>
                        <p class="text-muted small">or</p>
                        <input type="file" id="pitchFile" accept=".pdf,.ppt,.pptx" class="d-none" required>
                        <button type="button" class="btn btn-outline-primary" id="browseButton">Browse Files</button>
                    </div>
                    <small class="text-muted d-block mt-2">Accepted formats: PDF, PowerPoint (PPT, PPTX)</small>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="isPublic">
                        <label class="form-check-label" for="isPublic">
                            Make this pitch deck public
                        </label>
                    </div>
                </div>
                <div class="progress mb-3 d-none" id="uploadProgress">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div id="uploadStatus" class="alert d-none"></div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary" id="submitButton">Submit Pitch</button>
                </div>
            </form>
            <div id="previewContainer" class="mt-4 d-none">
                <h4>Preview</h4>
                <div class="ratio ratio-16x9">
                    <iframe id="filePreview" class="w-100 border rounded" sandbox="allow-same-origin allow-scripts allow-popups"></iframe>
                </div>
                <div class="mt-3">
                    <a id="downloadButton" class="btn btn-secondary" download>
                        <i class="fas fa-download me-2"></i>Download Pitch Deck
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js';
        import { getFirestore, collection, addDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { app } from './firebase-config.js';

        const auth = getAuth(app);
        const storage = getStorage(app);
        const db = getFirestore(app);

        const form = document.getElementById('pitchSubmissionForm');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('pitchFile');
        const browseButton = document.getElementById('browseButton');
        const progressBar = document.querySelector('#uploadProgress .progress-bar');
        const uploadStatus = document.getElementById('uploadStatus');
        const previewContainer = document.getElementById('previewContainer');
        const filePreview = document.getElementById('filePreview');
        const downloadButton = document.getElementById('downloadButton');
        const submitButton = document.getElementById('submitButton');

        // File selection handling
        browseButton.addEventListener('click', () => fileInput.click());

        // Drag and drop handling
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#0d6efd';
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.style.borderColor = '#dee2e6';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#dee2e6';
            const file = e.dataTransfer.files[0];
            if (isValidFile(file)) {
                fileInput.files = e.dataTransfer.files;
                showFilePreview(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && isValidFile(file)) {
                showFilePreview(file);
            }
        });

        function isValidFile(file) {
            const validTypes = ['application/pdf', 'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation'];
            if (!validTypes.includes(file.type)) {
                showError('Please upload a PDF or PowerPoint file');
                return false;
            }
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                showError('File size must be less than 10MB');
                return false;
            }
            return true;
        }

        function showFilePreview(file) {
            if (file.type === 'application/pdf') {
                const reader = new FileReader();
                reader.onload = (e) => {
                    filePreview.src = e.target.result;
                    previewContainer.classList.remove('d-none');
                };
                reader.readAsDataURL(file);
            } else {
                previewContainer.classList.add('d-none');
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!auth.currentUser) {
                showError('Please sign in to submit a pitch deck');
                return;
            }

            const file = fileInput.files[0];
            if (!file || !isValidFile(file)) {
                return;
            }

            const title = document.getElementById('pitchTitle').value;
            const description = document.getElementById('pitchDescription').value;
            const isPublic = document.getElementById('isPublic').checked;

            submitButton.disabled = true;
            showProgress();

            try {
                const fileName = `${Date.now()}_${file.name}`;
                const fileRef = ref(storage, `pitch-decks/${auth.currentUser.uid}/${fileName}`);
                
                const metadata = {
                    contentType: file.type,
                    customMetadata: {
                        title,
                        description,
                        isPublic: isPublic.toString(),
                        originalName: file.name,
                        uploadedBy: auth.currentUser.uid
                    }
                };

                const uploadTask = uploadBytesResumable(fileRef, file, metadata);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        updateProgress(progress);
                    },
                    (error) => {
                        showError('Upload failed: ' + error.message);
                        submitButton.disabled = false;
                    },
                    async () => {
                        try {
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            
                            // Save pitch metadata to Firestore
                            await addDoc(collection(db, 'pitches'), {
                                title,
                                description,
                                fileUrl: downloadURL,
                                fileName,
                                isPublic,
                                userId: auth.currentUser.uid,
                                createdAt: new Date(),
                                status: 'pending'
                            });

                            showSuccess('Pitch deck uploaded successfully!');
                            downloadButton.href = downloadURL;
                            setTimeout(() => {
                                window.location.href = 'dashboard.html';
                            }, 2000);
                        } catch (error) {
                            showError('Failed to save pitch metadata: ' + error.message);
                            submitButton.disabled = false;
                        }
                    }
                );
            } catch (error) {
                showError('Upload failed: ' + error.message);
                submitButton.disabled = false;
            }
        });

        function showProgress() {
            document.getElementById('uploadProgress').classList.remove('d-none');
            uploadStatus.classList.add('d-none');
        }

        function updateProgress(progress) {
            progressBar.style.width = progress + '%';
            progressBar.textContent = Math.round(progress) + '%';
        }

        function showError(message) {
            uploadStatus.classList.remove('d-none', 'alert-success');
            uploadStatus.classList.add('alert-danger');
            uploadStatus.textContent = message;
        }

        function showSuccess(message) {
            uploadStatus.classList.remove('d-none', 'alert-danger');
            uploadStatus.classList.add('alert-success');
            uploadStatus.textContent = message;
        }
    </script>
</body>
</html> 